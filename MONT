<?PHP
  $IDP = session()->get('id');
  $IDL = $request->compteid;

      $somme_budget_ligne= DB::table('rallongebudgets')
       ->join('comptes', 'rallongebudgets.souscompte', '=', 'comptes.id')
       ->Where('rallongebudgets.projetid', $IDP)
       ->Where('rallongebudgets.souscompte', $IDL)
       ->SUM('rallongebudgets.budgetactuel');


       $somme_activite_ligne= DB::table('activities')
       ->Where('projectid', $IDP)
       ->Where('compteidr', $IDL)
       ->SUM('montantbudget');


       $montant_somme = $request->montant + $somme_activite_ligne;

       if($somme_budget_ligne >= $montant_somme ){ 

            OK
       }else{

            non
       }




       $ID = session()->get('id');
      $compte = DB::table('rallongebudgets')
              ->join('comptes', 'rallongebudgets.souscompte', '=', 'comptes.id')
              ->Where('rallongebudgets.projetid', $ID)
              ->get();

              $sommerepartie= DB::table('rallongebudgets')
              ->join('comptes', 'rallongebudgets.souscompte', '=', 'comptes.id')
              ->Where('rallongebudgets.projetid', $key->id)
              ->SUM('budgetactuel');



              number_format($datElements->montant,0, ',', ' ')

              <option disabled="true" selected="true" value="">--Sélectionner sous compte--</option>










              <tr>
                                        <tr>
                                            <th style="width:50px">Num</th>
                                            <th style="width:600px">Description</th>
                                            <th style="width:150px">Unité</th>
                                            <th style="width:100px">Q<sup>té</sup></th>
                                            <th style="width:50px">Frequence</th>
                                            <th style="width:150px">P.U</th>
                                            <th style="width:200px">P.T</th>

                                            <th> </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><input  style="width:100%" type="number" id="numerodetail" name="numerodetail[]" value="1"></td>
                                            <td><input  style="width:100%" type="text" id="description" name="description[]"></td>
                                            <td><input  style="width:100%" type="text" class="unit_price"  id="unit_cost" name="unit_cost[]"></td>
                                            <td><input  style="width:100%" type="number" class="qty"  id="qty"  name="qty[]"></td>
                                            <td><input  style="width:100%" type="number" class="frenquency" id="frenquency"  name="frenquency[]""></td>
                                            <td><input  style="width:100%" type="number" class="frenquency" id="frenquency"  name="frenquency[]""></td>
                                            <td><input  style="width:100%" type="text"   class="total" id="amount" name="amount[]" value="0" readonly></td>
                                            <td><a href="javascript:void(0)" class="text-success font-18" title="Add" id="addBtn"><i class="fa fa-plus"></i></a></td>
                                        </tr>









                                        public function findfebelementretour(Request $request)
{
    $IDs = $request->ids; // Utilisez 'ids' pour obtenir tous les identifiants sélectionnés
    $devise = session()->get('devise');
    $budget = session()->get('budget');
    $IDP = session()->get('id');

    

    // Initialisez une variable pour stocker les sorties de tableau
    $output = '';
    $output .= '
    <table class="table table-striped table-sm fs--1 mb-0 table-bordered" style="width:100%">
   ';
    
    $totoglobale = 0; // Initialiser le total global à zéro
    $pourcentage_total = 0; // Initialiser le pourcentage total à zéro

    foreach ($IDs as $ID) {
        // Effectuez la recherche de données pour chaque identifiant sélectionné
        $data = DB::table('febs')
            ->where('febs.id', $ID)
            ->get();

      $vehicules = Vehicule::all();

           

      if ($data->count() > 0) {

        $totoSUM = DB::table('elementfebs')
            ->orderBy('id', 'DESC')
            ->where('febid', $ID)
            ->sum('montant');

        // Ajouter $totoSUM au total global
        $totoglobale += $totoSUM;

        // Générer la sortie HTML pour chaque élément sélectionné
        foreach ($data as $datas) {
            // sommes element
            $sommefeb = DB::table('elementfebs')
                ->Where('febid', $datas->id)
                ->Where('projetids', $IDP)
                ->SUM('montant');

            $ligneinfo = Compte::where('id', $datas->ligne_bugdetaire)
                ->first();

                

            $pourcentage = round(($sommefeb * 100) / $budget, 2);

            // Ajouter le pourcentage de cette itération au pourcentage total
            $pourcentage_total += $pourcentage;

            // Construire la sortie HTML pour chaque élément sélectionné
$output .= '<input type="hidden" name="febid[]" id="febid[]" value="' . $datas->id . '" /><input type="hidden" id="ligneid[]" name="ligneid[]" value="' . $datas->ligne_bugdetaire . '" />';
$output .= '<tr> <td width="5%" rowspan="3"> Numéro FEB : ' . $datas->numerofeb . '</td>';
$output .= '<td width="8%"> Facture<input type="number" name="facture[]" id="facture[]" style="width: 100%; border:1px solid #c0c0c0" /> </td>';
$output .= '<td width="10%"> Montant de l\'Avance <input type="number" name="montantavance[]" id="montantavance[]" style="width: 100%; border:1px solid #c0c0c0" /></td>';
$output .= '<td width="10%"> Montant utilisé* <input type="number" name="montantutiliser[]" id="montantutiliser[]" style="width: 100%; border:1px solid #c0c0c0" /></td>';
$output .= '<td width="10%">Surplus/Manque* <input type="number" name="surplus[]" id="surplus[]" style="width: 100%; border:1px solid #c0c0c0" /></td>';
$output .= '<td width="10%">Montant retourné <input type="number" id="montantretour[]" name="montantretour[]" style="width: 100%; border:1px solid #c0c0c0" /> </td><tr>';
$output .= '<tr>';


$output .= ' <td width="10%"> Bordereau  <input type="text" name="bordereau[]" id="bordereau[]" style="width: 100%; border:1px solid #c0c0c0" /></td>';
$output .= '<td width="6%"> Duré avance  <input type="number" name="duree_avence[]" id="duree_avence[]" style="width: 100%; border:1px solid #c0c0c0" /></td>';
$output .= '<td width="10%"> Date du <input type="number" name="datedu[]" id="datedu[]" style="width: 100%; border:1px solid #c0c0c0" /></td>';
$output .= '<td width="10%">Description  <input type="text" class="description" name="descriptionel[]" id="descriptionel[]" style="width: 100%; border:1px solid #c0c0c0" /></td>';
$output .= '<td> Séléctionner véhicule <select id="matriculenum"  name="matriculenum" style="width: 100%; border:1px solid #c0c0c0">';
$output .= '<option   value="" >Séléctionner vehicule</option>';
      
      // Utilisation de la syntaxe PHP pour générer les options
      foreach ($vehicules as $vehicule) {
          $output .= '<option value="' . $vehicule->id . '">' . $vehicule->matricule . '</option>';
      }
      
      $output .= '</select></td></tr>';
         

        }
      }
    }
    $output .= '</table>';
  
    return $output;
}
